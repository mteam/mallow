// Generated by CoffeeScript 1.4.0
(function() {
  var Bundle, Queue, async, ejs,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  async = require('async');

  ejs = require('ejs');

  Queue = require('./queue');

  Bundle = (function() {

    Bundle.template = ejs.compile(require('fs').readFileSync(__dirname + '/../lib/bundle_template.ejs', 'utf-8'));

    function Bundle() {
      this.server = __bind(this.server, this);
      this.packages = [];
    }

    Bundle.prototype.compile = function(cb) {
      var pkg, queue, _i, _len, _ref, _results;
      queue = Queue["new"]();
      queue.done = function(err) {
        var output;
        if (err) {
          return cb(err);
        }
        output = Bundle.template({
          modules: queue.modules
        });
        return cb(null, output);
      };
      _ref = this.packages;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        pkg = _ref[_i];
        _results.push(queue.compilePackage(pkg));
      }
      return _results;
    };

    Bundle.prototype.add = function(dir) {
      return this.packages.push(dir);
    };

    Bundle.prototype.server = function(req, res, next) {
      res.type('js');
      return this.compile(function(err, output) {
        if (err) {
          return next(err);
        }
        return res.end(output);
      });
    };

    return Bundle;

  })();

  module.exports = Bundle;

}).call(this);
